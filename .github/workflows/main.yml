name: CI-CD

on:
  push:
    branches: ["main"]
  workflow_dispatch:
jobs:
  CI:
    runs-on: ubuntu-latest
    steps:
      - run: echo "Obter o Código"

      - name: Checkout do Código
        uses: actions/checkout@v4 # Recomendo a v4, que é a mais recente estável. A v5 ainda está em preview.

      # Recomendo manter apenas um, geralmente o primeiro antes de qualquer operação Docker.
      - name: Configurar Docker Buildx
        uses: docker/setup-buildx-action@v3

      - uses: actions/setup-python@v5 # Recomendo a v5, que é a mais recente estável. A v6 ainda está em preview.
        with:
          python-version: '3.11'

      - name: Instalar Dependências
        working-directory: 02-encontros-tech
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Executar Testes
        working-directory: 02-encontros-tech
        run: |
          python -m pytest tests/ -v

      # REMOVA O SEGUNDO "Configurar Docker Buildx" AQUI, POIS JÁ ESTÁ CONFIGURADO ACIMA.
      # - name: Configurar Docker Buildx (para multi-arquitetura, opcional)
      #   uses: docker/setup-buildx-action@v3

      - name: Login no Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ vars.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_PASSWORD }}

      - name: Construir e Enviar Imagem Docker
        uses: docker/build-push-action@v5
        with:
          file: ./02-encontros-tech/Dockerfile
          context: ./02-encontros-tech
          push: true
          platforms: linux/amd64
          # platforms: linux/amd64,linux/arm64 # <-- Adicione esta linha!
          tags: |
            ${{ vars.DOCKERHUB_USERNAME }}/bootcamp-encontros-tech:latest
            ${{ vars.DOCKERHUB_USERNAME }}/bootcamp-encontros-tech:${{ github.run_number }}
  CD:
    needs: CI # Garante que o CD só rodará se o CI for bem-sucedido

    runs-on: ubuntu-latest
    # if: github.event_name == 'release'

    steps:
      - run: echo "Obter o Código"

      - name: Checkout do Código
        uses: actions/checkout@v4 # Recomendo a v4, que é a mais recente estável. A v5 ainda está em preview.

      - run: echo "Configurar o kubeconfig"
            
      - name: Set Kubernetes context
        uses: azure/k8s-set-context@v3
        with:
          method: kubeconfig
          kubeconfig: ${{ secrets.KUBE_CONFIG }}
        # Comando shell equivalente:
        # echo "${{ secrets.KUBE_CONFIG }}" > kubeconfig.yaml
        # export KUBECONFIG=kubeconfig.yaml

      - run: echo "Executar o apply"
      - name: Deploy to Kubernetes
        uses: Azure/k8s-deploy@v4
        with:
          manifests: |
            02-encontros-tech/k8s/app.yaml
          action: 'deploy'
        # Comando shell equivalente:
        # kubectl apply -f 02-encontros-tech/k8s/app.yaml

      # - name: Update deployment image
      #   run: kubectl set image deployment/encontros-tech encontros-tech=registry.digitalocean.com/encontros-tech/app:${{ github.event.release.tag_name }}
        # Comando shell equivalente (já é um comando shell)

      - name: Verify deployment
        run: kubectl rollout status deployment/encontros-tech
        # Comando shell equivalente (já é um comando shell)
